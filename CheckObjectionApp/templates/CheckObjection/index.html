<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Title</title>
<style>
.message {
height:300px;
border:1px solid #dddddd;
width:100%;
overflow-y: auto;
padding: 10px;
}
.debug {
color: gray;
font-size: 12px;
}
</style>
</head>
<body>
<div class="debug">调试信息: 群组号 = "{{ qq_group_num }}"</div>
<div class="message" id="message"></div>
<div>
<input type="text" placeholder="请输入" id="txt">
<input type="button" value="发送" onclick="sendMessage()">
<input type="button" value="关闭连接" onclick="closeConn()">
</div>
<script>
    // 调试信息
    let groupName = "{{ qq_group_num }}";
    console.log("群组名称:", groupName);

    // 如果群组名称为空，使用默认值
    if (!groupName || groupName.trim() === "") {
        groupName = "default_group";
        console.log("使用默认群组名称:", groupName);
    }

    // 构建 WebSocket URL
    let wsUrl = "ws://127.0.0.1:8000/ws/" + groupName + "/";
    console.log("WebSocket URL:", wsUrl);

    let socket = new WebSocket(wsUrl);

    function sendMessage() {
        let message = document.getElementById("txt").value;
        console.log("发送消息:", message);

        if (socket.readyState === WebSocket.OPEN) {
            socket.send(message);
            let tag = document.createElement("div");
            tag.innerText = "[我] " + message;
            document.getElementById("message").appendChild(tag);
        } else {
            console.error("WebSocket 未连接，当前状态:", socket.readyState);
            let tag = document.createElement("div");
            tag.innerText = "[错误] 连接未就绪，无法发送消息";
            tag.style.color = "red";
            document.getElementById("message").appendChild(tag);
        }
    }

    function closeConn() {
        console.log("手动关闭连接");
        socket.close();
    }

    socket.onopen = function (event) {
        console.log("WebSocket 连接成功建立");
        let tag = document.createElement("div");
        tag.innerText = "[连接成功]";
        tag.style.color = "green";
        document.getElementById("message").appendChild(tag);
    }

    socket.onmessage = function (event) {
        console.log("收到消息:", event.data);
        let tag = document.createElement("div");
        tag.innerText = event.data;
        document.getElementById("message").appendChild(tag);
    }

    socket.onerror = function (event) {
        console.error("WebSocket 错误:", event);
        let tag = document.createElement("div");
        tag.innerText = "[连接错误] - 查看控制台获取详细信息";
        tag.style.color = "red";
        document.getElementById("message").appendChild(tag);
    }

    socket.onclose = function (event) {
        console.log("WebSocket 连接关闭，代码:", event.code, "原因:", event.reason);
        let tag = document.createElement("div");
        tag.innerText = "[连接已关闭] - 代码: " + event.code;
        tag.style.color = "orange";
        document.getElementById("message").appendChild(tag);
    }
</script>
</body>
</html>