{% extends 'CheckObjection/base/base.html' %}
{% load objection_tags %}

{% block main %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- ä¸»å¡ç‰‡ -->
            <div class="card shadow-lg border-0">
                <!-- å¡ç‰‡å¤´éƒ¨ -->
                <div class="card-header bg-primary text-white py-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-import fa-2x me-3"></i>
                        <div>
                            <h2 class="h3 mb-1 fw-bold">æ‰¹é‡å¯¼å…¥æµ‹è¯•æ¡ˆä¾‹</h2>
                            <p class="mb-0 opacity-75">å¿«é€Ÿå¯¼å…¥å¤šä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œæ”¯æŒæ–‡æœ¬å’ŒJSONæ ¼å¼</p>
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰‡ä¸»ä½“ -->
                <div class="card-body p-5">
                    <form id="importForm">
                        {% csrf_token %}

                        <!-- é¢˜ç›®é€‰æ‹© -->
                        <div class="mb-4">
                            <label for="topicSelect" class="form-label fw-bold fs-5 text-dark mb-3">
                                <i class="fas fa-tasks me-2 text-primary"></i>é€‰æ‹©é¢˜ç›®
                            </label>
                            <select class="form-select form-select-lg border-2 py-3" id="topicSelect" name="topic_id" required>
                                <option value="">è¯·é€‰æ‹©é¢˜ç›®...</option>
                                {% for topic in topics %}
                                <option value="{{ topic.id }}">{{ topic.title }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- æ ¼å¼è¯´æ˜ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold fs-5 text-dark mb-3">
                                <i class="fas fa-info-circle me-2 text-info"></i>æµ‹è¯•æ¡ˆä¾‹æ ¼å¼è¯´æ˜
                            </label>
                            <div class="border-start border-4 border-info bg-light bg-opacity-25 p-4 rounded-end">
                                <div class="mb-3">
                                    <h6 class="fw-bold text-dark mb-2">ğŸ“ æ–‡æœ¬æ ¼å¼ï¼ˆæ¨èï¼‰</h6>
                                    <pre class="bg-dark text-light p-3 rounded fs-6"><code>è¾“å…¥æ•°æ®1
===
æœŸæœ›è¾“å‡º1
***
è¾“å…¥æ•°æ®2
===
æœŸæœ›è¾“å‡º2
***</code></pre>
                                </div>

                                <div>
                                    <h6 class="fw-bold text-dark mb-2">ğŸ”§ JSONæ ¼å¼</h6>
                                    <pre class="bg-dark text-light p-3 rounded fs-6"><code>[
  {
    "input": "è¾“å…¥1",
    "output": "è¾“å‡º1",
    "is_sample": true,
    "score": 10
  },
  {
    "input": "è¾“å…¥2",
    "output": "è¾“å‡º2",
    "is_sample": false,
    "score": 20
  }
]</code></pre>
                                </div>
                            </div>
                        </div>

                        <!-- æµ‹è¯•æ¡ˆä¾‹è¾“å…¥åŒºåŸŸ -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label for="testcasesText" class="form-label fw-bold fs-5 text-dark mb-0">
                                    <i class="fas fa-code me-2 text-success"></i>æµ‹è¯•æ¡ˆä¾‹å†…å®¹
                                </label>
                                <span id="testcaseCount" class="badge bg-secondary fs-6">0 ä¸ªæµ‹è¯•æ¡ˆä¾‹</span>
                            </div>
                            <textarea class="form-control border-2 fs-6" id="testcasesText" name="testcases_text"
                                     rows="12" placeholder="è¯·è¾“å…¥æµ‹è¯•æ¡ˆä¾‹å†…å®¹..."
                                     style="font-family: 'Courier New', monospace;" required></textarea>
                        </div>

                        <!-- æ ¼å¼é€‰æ‹© -->
                        <div class="mb-4">
                            <label class="form-label fw-bold fs-5 text-dark mb-3">
                                <i class="fas fa-magic me-2 text-warning"></i>å¿«é€Ÿæ ¼å¼æ¨¡æ¿
                            </label>
                            <div class="btn-group btn-group-lg w-100" role="group">
                                <button type="button" class="btn btn-outline-primary py-3 fw-semibold" onclick="loadTemplate('text')">
                                    <i class="fas fa-align-left me-2"></i>æ–‡æœ¬æ ¼å¼æ¨¡æ¿
                                </button>
                                <button type="button" class="btn btn-outline-success py-3 fw-semibold" onclick="loadTemplate('json')">
                                    <i class="fas fa-brackets-curly me-2"></i>JSONæ ¼å¼æ¨¡æ¿
                                </button>
                                <button type="button" class="btn btn-outline-danger py-3 fw-semibold" onclick="clearTextarea()">
                                    <i class="fas fa-trash me-2"></i>æ¸…ç©ºå†…å®¹
                                </button>
                            </div>
                        </div>

                        <!-- æäº¤æŒ‰é’® -->
                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" class="btn btn-primary btn-lg py-3 fw-bold fs-5" id="submitBtn">
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                <i class="fas fa-upload me-2"></i>å¯¼å…¥æµ‹è¯•æ¡ˆä¾‹
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="resultAlert" class="alert d-none mt-4 p-4 border-0 shadow-sm fs-5"></div>
        </div>
    </div>
</div>

<!-- æ·»åŠ  Font Awesome å›¾æ ‡ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
// åŠ è½½æ¨¡æ¿
function loadTemplate(type) {
    const textarea = document.getElementById('testcasesText');

    if (type === 'text') {
        textarea.value = `1 2
===
3
***
hello world
===
HELLO WORLD
***
array input
1 2 3 4 5
===
15
***`;
    } else if (type === 'json') {
        textarea.value = `[
  {
    "input": "1 2",
    "output": "3",
    "is_sample": true,
    "score": 10
  },
  {
    "input": "hello world",
    "output": "HELLO WORLD",
    "is_sample": false,
    "score": 10
  },
  {
    "input": "array input\\\\n1 2 3 4 5",
    "output": "15",
    "is_sample": false,
    "score": 20
  }
]`;
    }

    // æ›´æ–°è®¡æ•°
    updateTestCaseCount();
}

// æ¸…ç©ºæ–‡æœ¬åŒºåŸŸ
function clearTextarea() {
    document.getElementById('testcasesText').value = '';
    updateTestCaseCount();
}

// æ›´æ–°æµ‹è¯•æ¡ˆä¾‹è®¡æ•°
function updateTestCaseCount() {
    const content = document.getElementById('testcasesText').value.trim();
    const countElement = document.getElementById('testcaseCount');

    if (!content) {
        countElement.textContent = '0 ä¸ªæµ‹è¯•æ¡ˆä¾‹';
        countElement.className = 'badge bg-secondary fs-6';
        return;
    }

    let count = 0;

    // æ£€æŸ¥æ˜¯å¦ä¸ºJSONæ ¼å¼
    if (content.trim().startsWith('[')) {
        try {
            const data = JSON.parse(content);
            count = Array.isArray(data) ? data.length : 0;
        } catch (e) {
            // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå›é€€åˆ°æ–‡æœ¬æ ¼å¼è®¡æ•°
            count = content.split('***').filter(s => s.trim()).length;
        }
    } else {
        // æ–‡æœ¬æ ¼å¼è®¡æ•°
        count = content.split('***').filter(s => s.trim()).length;
    }

    countElement.textContent = `${count} ä¸ªæµ‹è¯•æ¡ˆä¾‹`;

    // æ ¹æ®æ•°é‡æ”¹å˜é¢œè‰²
    if (count === 0) {
        countElement.className = 'badge bg-secondary fs-6';
    } else if (count <= 5) {
        countElement.className = 'badge bg-success fs-6';
    } else if (count <= 20) {
        countElement.className = 'badge bg-info fs-6';
    } else {
        countElement.className = 'badge bg-warning fs-6';
    }
}

// è¡¨å•æäº¤å¤„ç†
document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const resultAlert = document.getElementById('resultAlert');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    resultAlert.classList.add('d-none');

    try {
        const formData = {
            topic_id: document.getElementById('topicSelect').value,
            testcases_text: document.getElementById('testcasesText').value
        };

        const response = await fetch('{% url_batch_import_testcases %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        // æ˜¾ç¤ºç»“æœ
        resultAlert.classList.remove('d-none');
        if (data.success) {
            resultAlert.className = 'alert alert-success d-flex align-items-center border-0 shadow-sm fs-5';
            resultAlert.innerHTML = `
                <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                <div>
                    <h5 class="alert-heading fw-bold mb-2">å¯¼å…¥æˆåŠŸï¼</h5>
                    <p class="mb-0">${data.message}</p>
                </div>
            `;
            // æ¸…ç©ºè¡¨å•
            document.getElementById('importForm').reset();
            updateTestCaseCount();
        } else {
            resultAlert.className = 'alert alert-danger d-flex align-items-center border-0 shadow-sm fs-5';
            resultAlert.innerHTML = `
                <i class="fas fa-exclamation-triangle fa-2x me-3 text-danger"></i>
                <div>
                    <h5 class="alert-heading fw-bold mb-2">å¯¼å…¥å¤±è´¥ï¼</h5>
                    <p class="mb-0">${data.error}</p>
                </div>
            `;
        }

    } catch (error) {
        resultAlert.classList.remove('d-none');
        resultAlert.className = 'alert alert-danger d-flex align-items-center border-0 shadow-sm fs-5';
        resultAlert.innerHTML = `
            <i class="fas fa-exclamation-triangle fa-2x me-3 text-danger"></i>
            <div>
                <h5 class="alert-heading fw-bold mb-2">è¯·æ±‚å¤±è´¥ï¼</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.disabled = false;
        spinner.classList.add('d-none');

        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        resultAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});

// å®æ—¶ç»Ÿè®¡æµ‹è¯•æ¡ˆä¾‹æ•°é‡
document.getElementById('testcasesText').addEventListener('input', updateTestCaseCount);

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è®¡æ•°
document.addEventListener('DOMContentLoaded', updateTestCaseCount);
</script>

<style>
.card {
    border-radius: 1rem;
    overflow: hidden;
}

.card-header {
    border-bottom: none;
    border-radius: 1rem 1rem 0 0 !important;
}

.form-select, .form-control {
    border-radius: 0.75rem;
    font-size: 1.1rem;
    transition: all 0.3s ease;
}

.form-select:focus, .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    transform: translateY(-2px);
}

.btn {
    border-radius: 0.75rem;
    transition: all 0.3s ease;
    font-size: 1.1rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.btn-group .btn {
    border-radius: 0.5rem;
    margin: 0 2px;
}

.alert {
    border-radius: 1rem;
}

.badge {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
}

pre {
    margin: 0;
    line-height: 1.5;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .card-body {
        padding: 2rem !important;
    }

    .btn-group {
        flex-direction: column;
    }

    .btn-group .btn {
        margin: 2px 0;
        border-radius: 0.5rem;
    }
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
.form-control::-webkit-scrollbar {
    width: 8px;
}

.form-control::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 0 0.75rem 0.75rem 0;
}

.form-control::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.form-control::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}